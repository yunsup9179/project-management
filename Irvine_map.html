<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irvine City Coverage Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #f8fafc; }
        .overlay { pointer-events: none; }
        .overlay > * { pointer-events: auto; }
        
        /* Custom Marker Labels */
        .custom-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #334155;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before, .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before {
            border: none !important;
        }
    </style>
</head>
<body class="bg-slate-50 flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-20 flex justify-between items-center relative">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 p-2 rounded-lg text-white">
                <i data-lucide="map" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Irvine 3-Mile Coverage Map</h1>
                <p class="text-xs text-slate-500">EV Charger Locations</p>
            </div>
        </div>
        
        <div id="status-indicator" class="hidden flex items-center gap-2 text-slate-600 bg-slate-100 px-3 py-1.5 rounded-full text-sm font-medium transition-all">
            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
            <span id="status-text">Loading Data...</span>
        </div>
    </header>

    <!-- Map Container -->
    <div class="flex-1 relative">
        <div id="map"></div>

        <!-- Legend Overlay -->
        <div class="absolute bottom-8 right-6 w-64 bg-white/95 backdrop-blur-md p-5 rounded-2xl shadow-xl border border-slate-100 z-[400] overlay">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2 mb-4">
                <i data-lucide="info" class="w-4 h-4 text-slate-500"></i>
                Legend
            </h3>
            
            <div class="space-y-4">
                <!-- Existing -->
                <div class="flex items-start gap-3">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" class="w-4 h-6 mt-0.5" alt="Blue Marker">
                    <div>
                        <p class="font-bold text-sm text-slate-800">Existing Locations</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-3 h-3 rounded-full bg-blue-500 opacity-20 border border-blue-500"></span>
                            <span class="text-xs text-slate-500">3-Mile Radius</span>
                        </div>
                    </div>
                </div>

                <!-- Future -->
                <div class="flex items-start gap-3">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png" class="w-4 h-6 mt-0.5" alt="Gold Marker">
                    <div>
                        <p class="font-bold text-sm text-slate-800">Future Locations</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-3 h-3 rounded-full bg-yellow-500 opacity-20 border border-yellow-500"></span>
                            <span class="text-xs text-slate-500">3-Mile Radius</span>
                        </div>
                    </div>
                </div>

                <!-- Boundary -->
                 <div class="flex items-center gap-3 pt-2 border-t border-slate-100 mt-2">
                    <div class="w-8 h-0.5 bg-red-500 border-t border-dashed border-red-500"></div>
                    <span class="text-xs text-slate-500 font-medium">Irvine City Limits</span>
                </div>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-100 flex gap-2">
                 <button onclick="setLayer('light')" class="flex-1 py-1.5 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-600 rounded transition-colors">Light</button>
                 <button onclick="setLayer('dark')" class="flex-1 py-1.5 text-xs font-medium bg-slate-800 hover:bg-slate-900 text-white rounded transition-colors">Dark</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // 3 miles in meters = 4828.03
        const RADIUS_METERS = 4828; 

        // Updated Locations with Precise Coordinates
        const locations = [
            // Existing (Blue)
            { name: "Trabuco Community Center", type: "existing", lat: 33.695414, lng: -117.759676 }, // Updated Coordinates
            // Slight offset for visibility since it shares coords with Future station
            { name: "Irvine Metrolink Station (L2)", type: "existing", lat: 33.656983, lng: -117.733553 }, 

            // Future (Yellow/Gold)
            { name: "David Sills Park DCFC", type: "future", lat: 33.715689, lng: -117.778539 },
            { name: "Portola Springs Park DCFC", type: "future", lat: 33.696611, lng: -117.700692 },
            { name: "Irvine Civic Center DCFC", type: "future", lat: 33.686376, lng: -117.826384 },
            // Slight offset for visibility to avoid exact overlap with L2
            { name: "Irvine Metrolink Station (DCFC)", type: "future", lat: 33.657200, lng: -117.733200 }, 
            { name: "Irvine Fieldhouse Level 2", type: "future", lat: 33.696757, lng: -117.851636 },
            { name: "Heritage Park Level 2", type: "future", lat: 33.700276, lng: -117.779664 },
            { name: "Las Lomas Park", type: "future", lat: 33.630142, lng: -117.828553 }
        ];

        // Calculate Map Center based on points
        const lats = locations.map(l => l.lat);
        const lngs = locations.map(l => l.lng);
        const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
        const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;

        // Map Setup
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([centerLat, centerLng], 12);

        L.control.zoom({ position: 'topright' }).addTo(map);
        L.control.attribution({ position: 'bottomright', prefix: false }).addTo(map);

        // Tile Layers
        const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM &copy; CARTO',
            maxZoom: 20
        });
        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM &copy; CARTO',
            maxZoom: 20
        });

        lightLayer.addTo(map);

        function setLayer(type) {
            map.eachLayer((layer) => { if (layer instanceof L.TileLayer) map.removeLayer(layer); });
            if (type === 'light') lightLayer.addTo(map);
            if (type === 'dark') darkLayer.addTo(map);
        }

        // Custom Markers
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const goldIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Add Markers and Circles
        locations.forEach(loc => {
            const isExisting = loc.type === 'existing';
            const color = isExisting ? '#3b82f6' : '#eab308'; // Blue-500 vs Yellow-500
            const icon = isExisting ? blueIcon : goldIcon;
            
            // Circle Area
            L.circle([loc.lat, loc.lng], {
                color: color,
                fillColor: color,
                fillOpacity: 0.1,
                radius: RADIUS_METERS,
                weight: 1,
                dashArray: isExisting ? null : '4, 4'
            }).addTo(map);

            // Marker with Permanent Tooltip (Label)
            const marker = L.marker([loc.lat, loc.lng], { icon: icon })
                .bindTooltip(loc.name, {
                    permanent: true,
                    direction: 'top',
                    className: 'custom-label',
                    offset: [0, -35]
                })
                .bindPopup(`
                    <div class="font-sans p-1">
                        <strong class="text-sm block mb-1 text-slate-800">${loc.name}</strong>
                        <span class="text-xs px-2 py-0.5 rounded-full text-white font-bold ${isExisting ? 'bg-blue-500' : 'bg-yellow-500'}">
                            ${isExisting ? 'Existing' : 'Future Site'}
                        </span>
                        <p class="text-xs text-slate-500 mt-2">
                            Lat: ${loc.lat.toFixed(4)}<br>
                            Lng: ${loc.lng.toFixed(4)}
                        </p>
                    </div>
                `);
            
            marker.addTo(map);
        });

        // Boundary Logic
        let geoJsonLayer = null;
        async function fetchBoundary() {
            try {
                const response = await fetch(
                    'https://nominatim.openstreetmap.org/search?city=Irvine&state=California&country=USA&polygon_geojson=1&format=json'
                );
                if (!response.ok) return;
                const data = await response.json();
                const boundaryData = data.find(item => item.geojson && (item.type === 'administrative' || item.class === 'boundary')) || data[0];
                
                if (boundaryData && boundaryData.geojson) {
                    geoJsonLayer = L.geoJSON(boundaryData.geojson, {
                        style: {
                            color: '#ef4444',
                            weight: 2,
                            opacity: 0.6,
                            fill: false,
                            dashArray: '8, 6'
                        }
                    }).addTo(map);
                }
            } catch (err) {
                console.error("Boundary fetch failed", err);
            }
        }
        fetchBoundary();

    </script>
</body>
</html>